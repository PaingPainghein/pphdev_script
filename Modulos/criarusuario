#!/bin/bash
# ... (လက်ရှိ code ထဲက အစိတ်အပိုင်းတွေ ဆက်လက်ထားရှိမယ်)
# Token နာမည်ပြောင်းခြင်း
fun_rename_token() {
    clear
    tput setaf 7
    tput setab 4
    tput bold
    printf '%30s%s%-15s\n' "Token နာမည်ပြောင်းရန်"
    tput sgr0
    echo ""
    echo -ne "\033[1;32mလက်ရှိ Token နာမည်: \033[1;37m "
    read old_username
    [[ -z $old_username ]] && {
        echo -e "\n${cor1}Token နာမည်မထည့်ပါ!\n"
        sleep 2
        return
    }
    [[ "$(grep -wc $old_username /etc/passwd)" == '0' ]] && {
        echo -e "\n${cor1}ဒီ Token မရှိပါ!\n"
        sleep 2
        return
    }
    echo -ne "\033[1;32mနာမည်သစ်: \033[1;37m "
    read new_username
    [[ -z $new_username ]] && {
        echo -e "\n${cor1}နာမည်သစ်မထည့်ပါ!\n"
        sleep 2
        return
    }
    [[ "$(grep -wc $new_username /etc/passwd)" != '0' ]] && {
        echo -e "\n${cor1}ဒီနာမည်သစ်ကို အသုံးပြုပြီးသားဖြစ်နေပါတယ်!\n"
        sleep 2
        return
    }
    [[ ${new_username} != ?(+|-)+([a-zA-Z0-9]) ]] && {
        echo -e "\n${cor1}နာမည်သစ်မမှန်ကန်ပါ! အက္ခရာ သို့မဟုတ် ဂဏန်းများသာ အသုံးပြုပါ!\n"
        sleep 2
        return
    }
    # /etc/passwd မှာ နာမည်ပြောင်းမယ်
    sed -i "s/^$old_username:/$new_username:/" /etc/passwd
    # /root/usuarios.db မှာ နာမည်ပြောင်းမယ်
    sed -i "s/^$old_username /$new_username /" /root/usuarios.db
    # /etc/SSHPlus/senha/ ဖိုင်ကို ပြောင်းမယ်
    mv /etc/SSHPlus/senha/$old_username /etc/SSHPlus/senha/$new_username
    # OVPN ဖိုင်ကို ပြန်ဖန်တီးမယ်
    rm -f /root/$old_username.ovpn /root/$old_username.zip
    username=$new_username
    fun_geraovpn
    echo -e "\n\033[1;32mToken နာမည်ကို $new_username အဖြစ် ပြောင်းလဲပြီးပါပြီ!\033[0m"
    sleep 2
}

# Token ဖျက်ခြင်း
fun_delete_token() {
    clear
    tput setaf 7
    tput setab 4
    tput bold
    printf '%30s%s%-15s\n' "Token ဖျက်ရန်"
    tput sgr0
    echo ""
    echo -ne "\033[1;32mဖျက်လိုသော Token နာမည်: \033[1;37m "
    read username
    [[ -z $username ]] && {
        echo -e "\n${cor1}Token နာမည်မထည့်ပါ!\n"
        sleep 2
        return
    }
    [[ "$(grep -wc $username /etc/passwd)" == '0' ]] && {
        echo -e "\n${cor1}ဒီ Token မရှိပါ!\n"
        sleep 2
        return
    }
    echo -ne "\033[1;32mတကယ်ဖျက်မှာလား? [y/n]: \033[1;37m "
    read confirm
    [[ "$confirm" != @(y|Y) ]] && {
        echo -e "\n\033[1;31mဖျက်ခြင်းကို ပယ်ဖျက်လိုက်ပါတယ်!\n"
        sleep 2
        return
    }
    # Token ကို ဖျက်မယ်
    userdel -r $username >/dev/null 2>&1
    sed -i "/^$username /d" /root/usuarios.db
    rm -f /etc/SSHPlus/senha/$username
    rm -f /root/$username.ovpn /root/$username.zip
    echo -e "\n\033[1;32mToken $username ကို ဖျက်ပြီးပါပြီ!\033[0m"
    sleep 2
}

# မီနူးထဲမှာ ထည့်သွင်းဖို့
fun_main_menu() {
    clear
    tput setaf 7
    tput setab 4
    tput bold
    printf '%30s%s%-15s\n' "SSH အကောင့်စီမံခန့်ခွဲမှု"
    tput sgr0
    echo ""
    echo -e "\033[1;31m[\033[1;36m1\033[1;31m] \033[1;33mToken ဖန်တီးရန်"
    echo -e "\033[1;31m[\033[1;36m2\033[1;31m] \033[1;33mToken နာမည်ပြောင်းရန်"
    echo -e "\033[1;31m[\033[1;36m3\033[1;31m] \033[1;33mToken ဖျက်ရန်"
    echo -e "\033[1;31m[\033[1;36m4\033[1;31m] \033[1;33mHost ပြောင်းရန်"
    echo -e "\033[1;31m[\033[1;36m0\033[1;31m] \033[1;33mထွက်ရန်"
    echo ""
    echo -ne "\033[1;32mဘာလုပ်ချင်လဲ? \033[1;37m "
    read option
    case $option in
        1) fun_usertoken ;;
        2) fun_rename_token ;;
        3) fun_delete_token ;;
        4) fun_edithost ;;
        0) exit 0 ;;
        *) echo -e "\n\033[1;31mမမှန်ကန်တဲ့ ရွေးချယ်မှုပါ!\033[0m"; sleep 2; fun_main_menu ;;
    esac
}

# Script ကို စတင်ရန်
fun_main_menu